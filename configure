#!/bin/sh

if [ `uname -s | grep -i bsd` ]; then
	MAKEVAR=bsd
else
	MAKEVAR=gnu
fi

PREFIX="/usr/local"
FONTDIR="fonts/ibm-fonts"
OBJDIR="pcf"

eval set -- "`getopt -o d --long prefix:,fontdir:,objdir:,make-variant: -n 'configure' -- "$@"`"

while true ; do
	case "$1" in
		--prefix)
			PREFIX="$2"; shift 2 ;;
		--fontdir)
			FONTDIR="$2"; shift 2 ;;
		--objdir)
			OBJDIR="$2"; shift 2 ;;
		--make-variant)
			MAKEVAR="$2"; shift 2 ;;
		--)
			shift; break ;;
		*)
			printf "usage: $0 [--make-variant=<bsd|gnu>] [--prefix=<PATH>] [--fontdir=<PATH>] [--objdir=<PATH>]"
			break ;;
	esac
done

if [ "$MAKEVAR" = bsd ]; then
	SRCDECL=".PATH.bdf: \$(.CURDIR)/bdf"
	OBJDECL=".OBJDIR: \$(OBJDIR:U$OBJDIR)"
	BUILDTARGET=".bdf.pcf.gz:"
	OBJPRE=""
else
	SRCDECL="VPATH = \$(CURDIR)/bdf"
	OBJDECL="OBJDIR = $OBJDIR"
	BUILDTARGET="\$(OBJDIR)/%.pcf.gz: %.bdf"
	OBJPRE="\$(OBJDIR)/"
fi

ALLRULE="all:"

INSTALLRULE="install: all
	install -dm755 \$(DESTDIR)\$(fontdir)"

UNINSTALLRULE="uninstall:"

for BDF in bdf/*.bdf; do
	PCF="`basename -s .bdf $BDF`.pcf.gz"

	ALLRULE="$ALLRULE $OBJPRE$PCF"

	INSTALLRULE="$INSTALLRULE
	install -Dm644 $OBJPRE$PCF \$(DESTDIR)\$(fontdir)"

	UNINSTALLRULE="$UNINSTALLRULE
	rm -f \$(DESTDIR)\$(fontdir)/$PCF"
done

mkdir -p "$OBJDIR"

cat << EOF > Makefile
.PHONY: all clean install uninstall
.SUFFIXES:
.SUFFIXES: .bdf .pcf.gz

$SRCDECL
$OBJDECL

prefix = $PREFIX
datarootdir = \$(prefix)/share
fontdir = \$(datarootdir)/$FONTDIR

$ALLRULE

clean:
	rm -f ${OBJPRE}*.pcf.gz 

$INSTALLRULE

$UNINSTALLRULE

$BUILDTARGET
	bdftopcf \$< | gzip > \$@

EOF
