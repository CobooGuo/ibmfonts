#!/usr/bin/env bash

PREFIX="/usr/local"
FONTDIR="/share/fonts/ibm-fonts"

eval set -- "$(getopt -o d --long prefix:,fontdir: -n 'configure' -- "$@")"

while true ; do
    case "$1" in
        --prefix)
            PREFIX="$2"; shift 2 ;;
        --fontdir)
            FONTDIR="$2"; shift 2 ;;
        --)
            shift; break ;;
        *)
            printf "usage: $0 [--prefix=<PATH>] [--fontdir=<PATH>]"
            break ;;
    esac
done

ALL="all:"
INSTALL="install: all
	install -dm755 \$(DESTDIR)\$(fontdir)"
UNINSTALL="uninstall:"
TARGETS=""

for BDF in *.bdf; do
    PCF=$(basename -s .bdf $BDF).pcf.gz

    ALL="$ALL $PCF"

    INSTALL="$INSTALL
	install -Dm644 $PCF \$(DESTDIR)\$(fontdir)"

    UNINSTALL="$UNINSTALL
	rm -f \$(DESTDIR)\$(fontdir)/$PCF"

    TARGETS="$TARGETS
$PCF:
	bdftopcf $BDF | gzip > $PCF
"
done

cat << EOF > makefile
.PHONY: all clean install uninstall

prefix = $PREFIX
fontdir = \$(prefix)$FONTDIR

$ALL

clean:
	rm -f *.pcf.gz 

$INSTALL

$UNINSTALL
$TARGETS
EOF
