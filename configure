#!/bin/sh

PREFIX="/usr/local"
SRCDIR=""
OBJDIR=""
INSTALLDIR=""
MAKEVAR="gnu"

eval set -- "`getopt -o p:i:o:s:b --long prefix:,objdir:,srcdir:,installdir:,bsd-make -n "$0" -- "$@"`"

while true ; do
	case "$1" in
		-p|--prefix)
			PREFIX="$2"; shift 2 ;;
		-o|--objdir)
			OBJDIR="$2"; shift 2 ;;
		-s|--srcdir)
			SRCDIR="$2"; shift 2 ;;
		-b|--bsd-make)
			MAKEVAR="bsd"; shift ;;
		-i|--installdir)
			INSTALLDIR="$2"; shift 2 ;;
		--)
			shift; break ;;
		*)
			exit 1 ;;
	esac
done

if [ "$MAKEVAR" = bsd ]; then
	setobjdecl() { OBJDECL=".OBJDIR: \$(objdir:U$1)"; }

	CURDIR="\$(.CURDIR)"
	SHELLDECL=".SHELL: name=sh path=/bin/sh"
	SRCDECL=".PATH.bdf: \$(srcdir)"
	BUILDRULE=".bdf.pcf.gz:"
	TARGETS="\$(PCF)"
	INSTALLED="\$(PCF:@.FILE.@\$(DESTDIR)\$(installdir)/\$(.FILE.)@)"
else
	setobjdecl() { OBJDECL="objdir = $1"; }

	CURDIR="\$(CURDIR)"
	SHELLDECL="SHELL = /bin/sh"
	SRCDECL="vpath %.bdf \$(srcdir)"
	BUILDRULE="\$(objdir)/%.pcf.gz: %.bdf"
	TARGETS="\$(addprefix \$(objdir)/, \$(PCF))"
	INSTALLED="\$(addprefix \$(DESTDIR)\$(installdir)/, \$(PCF))"
fi

case "$SRCDIR" in
    '') SRCDIR="$CURDIR/bdf" ;;
    /*) ;;
    *) SRCDIR="\$(prefix)/$SRCDIR" ;;
esac

case "$OBJDIR" in
    '') mkdir -p `pwd`/pcf
        OBJDIR="$CURDIR/pcf"
        ;;
    /*) mkdir -p "$OBJDIR"
        ;;
    *)  mkdir -p "$PREFIX/$OBJDIR"
        OBJDIR="\$(prefix)/$OBJDIR"
        ;;
esac

setobjdecl "$OBJDIR"

case "$INSTALLDIR" in
    '') INSTALLDIR="\$(fontdir)/misc" ;;
    /*) ;;
    *) INSTALLDIR="\$(fontdir)/$INSTALLDIR" ;;
esac

for BDF in bdf/*.bdf; do
	if [ -z "$PCF" ]; then
		PCF="`basename -s .bdf $BDF`.pcf.gz"
	else
		PCF="$PCF `basename -s .bdf $BDF`.pcf.gz"
	fi
done

cat << EOF > Makefile
$SHELLDECL

.PHONY: all clean install uninstall
.SUFFIXES:
.SUFFIXES: .bdf .pcf.gz

prefix = $PREFIX
srcdir = $SRCDIR
datarootdir = \$(prefix)/share
fontdir = \$(datarootdir)/fonts
installdir = $INSTALLDIR

$SRCDECL
$OBJDECL

PCF = $PCF

TARGETS = $TARGETS

all: \$(TARGETS)

clean:
	rm -f \$(TARGETS)

install: all
	install -dm755 \$(DESTDIR)\$(installdir)
	install -D -m 644 -t \$(DESTDIR)\$(installdir) \$(TARGETS)

uninstall:
	rm -f $INSTALLED 

$BUILDRULE
	bdftopcf \$< | gzip > \$@

EOF
